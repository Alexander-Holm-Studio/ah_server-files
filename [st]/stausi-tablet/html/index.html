<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESX Tablet</title>
  <link href="bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="style.css" rel="stylesheet">
</head>
<body>

  <div id="tablet" class="container-fluid pt-2 fill-height tablet">
    <div class="buttons">
      <button id="close-btn" type="button" class="btn btn-primary btn-lg">
        Luk <i class="fas fa-times-circle"></i>
      </button>
    </div>
    <iframe src="" class="tablet-if"></iframe>
  </div>

  <script>
    class TabletManager {
      constructor() {
        this.tablet = document.getElementById('tablet');
        this.closeBtn = document.getElementById('close-btn');
        this.iframe = document.querySelector('iframe');
        this.currentTabletType = null;
        this.lastLogos = null;
        
        this.init();
      }

      init() {
        window.addEventListener('message', (event) => this.handleMessage(event));
        this.closeBtn.addEventListener('click', () => this.closeTablet());
        this.iframe.onload = () => this.handleIframeLoad();
        
        // Check for redirects
        setInterval(() => this.checkRedirects(), 1000);
      }

      handleMessage(event) {
        const { action, url, logoUrl, selector } = event.data;

        switch (action) {
          case 'show':
            this.showTablet(url);
            break;
          case 'hide':
            this.hideTablet();
            break;
          case 'updateLogos':
            this.updateLogos(logoUrl, selector);
            break;
        }
      }

      showTablet(url) {
        if (url) {
          this.iframe.src = url;
          this.currentTabletType = url.includes('/police/') ? 'police' : 'ems';
        }
        this.tablet.style.display = 'flex';
      }

      hideTablet() {
        this.tablet.style.display = 'none';
        this.iframe.src = 'about:blank';
        this.currentTabletType = null;
      }

      updateLogos(logoUrl, selector) {
        this.lastLogos = { logoUrl, selector };
        this.tryUpdateLogo();
      }

      tryUpdateLogo() {
        if (!this.lastLogos) return;

        try {
          const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;
          const logo = iframeDoc.querySelector(this.lastLogos.selector);
          if (logo) {
            logo.src = this.lastLogos.logoUrl;
          }
        } catch (e) {
          console.warn('Could not update logo:', e);
        }
      }

      closeTablet() {
        fetch(`https://${GetParentResourceName()}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        }).catch(() => {}); // Ignore fetch errors during resource restart
      }

      handleIframeLoad() {
        try {
          const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;
          
          // Hide back to start links
          const links = iframeDoc.querySelectorAll('a');
          links.forEach(link => {
            if (link.textContent.includes('Tilbage til start')) {
              link.style.display = 'none';
            }
          });

          // Add credit
          const footer = iframeDoc.querySelector('.front-page-footer');
          if (footer && !iframeDoc.getElementById('tablet-credit-extra')) {
            const credit = iframeDoc.createElement('h1');
            credit.id = 'tablet-credit-extra';
            credit.textContent = 'ESX Tablet by Simonfas';
            footer.appendChild(credit);
          }
          
          this.tryUpdateLogo();
        } catch (e) {
          // Cross-origin restrictions
        }
      }

      checkRedirects() {
        try {
          const path = this.iframe.contentWindow.location.pathname;
          if (path.endsWith('index.html')) {
            const redirectUrl = this.currentTabletType === 'police' 
              ? 'http://localhost/police/pages/login.php'
              : 'http://localhost/ems/pages/login.php';
            
            if (redirectUrl) {
              this.iframe.contentWindow.location.href = redirectUrl;
            }
          }
        } catch (e) {
          // Cross-origin restrictions
        }
      }
    }

    // Initialize tablet manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new TabletManager();
    });
  </script>
</body>
</html>
